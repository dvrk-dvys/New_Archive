tests:

  - name: listing-viewed.jslt compiles
    type: compile
    expression: |
      import "checks/core-tagging-plan/listing-viewed.jslt" as c
      c(.)

  - name: listing-viewed.jslt generates metrics for a valid event
    expected:
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: event_id_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: event_id_valid_format
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: event_type_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: event_name_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_id_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_id_valid_format
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_type_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_type_valid
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_category_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_numitems_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_url_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_adtype_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_currency_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_locality_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_maxprice_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_numresults_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_publishertype_not_null
            check-result: 'false'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_region_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
      - quality.check:
          tags:
            product-type: web
            tracker-type: js
            event-type: list-view
            check-suite: core_tagging_plan.listing_viewed
            check-name: object_filters_query_not_null
            check-result: 'true'
            check-impact: blocker
          delta: 1
    expression: |
      import "checks/core-tagging-plan/listing-viewed.jslt" as c

      let event =
      {
        "schema": "http://schema.schibsted.com/events/tracker-event.json/161.json",
        "origin": {
          "url": "https://www.yapo.cl/atacama/todos_los_avisos?ca=4_s&l=0&q=bicicleta&w=1&cmn="
        },
        "name": "Listing viewed",
        "creationDate": "2019-07-16T09:13:02.866Z",
        "published": "2019-07-16T09:13:01.927Z",
        "pageViewId": "e23cea60-8574-409b-857e-820aa18839fc",
        "provider": {
          "@type": "Organization",
          "@id": "sdrn:schibsted:client:yapocl",
          "productType": "Web"
        },
        "device": {
          "acceptLanguage": "en-US",
          "deviceType": "desktop",
          "environmentId": "sdrn:schibsted:environment:a2029f7e-1a7f-46db-a683-b4f62e0ec9ad",
          "jweIds": "eyJhbGciOiJBMTI4S1ciLCJlbmMiOiJBMTI4R0NNIn0.1rCvgZU-wfbZ2SaPjwtzbgbgrA4eMa7t.UA4RBtNGMww3s05l.LxNPW9VKQbmHMy1L1SrHtd3xZtRLsdIB7KYZXiEcXTFtNbXKMbm9aQhcajymFDMOWB_3DsYS2e_lp55-3ptpxvj9Ttg2Alw9D0whQlLgo5YTjSijWsk1jpnrcWA2HwyvHakfpI4jne9nBSOLS9vt_GlHV2IFqS7PW0ITjpSoXZBRJejzJtj7IZnnICuWJnU0RBplXJ6dZL199uB0AcVC7v46jO8IItEoA2eSrd3JRZFSvRb6S_244Sg.gNJrRPleXE011yjCOANVgg",
          "screenSize": "1680x1050",
          "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.104 Safari/537.36",
          "viewportSize": "1313x502"
        },
        "tracker": {
          "eventBuilderVersion": "1.0.32",
          "name": "Pulse Node.js SDK",
          "type": "JS",
          "version": "4.1.8-75ce0"
        },
        "@type": "View",
        "@id": "415428f3-dc13-4e59-bdff-38abaadb3fbe",
        "object": {
          "@id": "sdrn:yapocl:listing:https://www.yapo.cl/atacama/bicicletas_ciclismo?ca=4_s&l=0&q=bicicleta&w=1&cmn=",
          "@type": "Listing",
          "name": "Yapo.cl - 102 avisos de bicicleta de Bicicletas, ciclismo y accesorios publicados en III Atacama",
          "url": "https://www.yapo.cl/atacama/bicicletas_ciclismo?ca=4_s&l=0&q=bicicleta&w=1&cmn=",
          "filters": {
            "query": "bicicleta",
            "adType": "sell",
            "region": "III Atacama"
          },
          "numItems": 247,
          "category": "Tiempo libre > Bicicletas ciclismo y accesorios"
        }
      }
      c($event)

