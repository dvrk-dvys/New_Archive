tests:

  - name: classified-ad-interactions.jslt compiles
    type: compile
    expression: |
      import "checks/p10n/classified-ad-interactions.jslt" as c
      c(.)

  - name: classified-ad-interactions.jslt generates metrics for a valid event
    expected:
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: data_is_fresh_than_5
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: data_is_fresh_than_15
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: data_is_fresh_than_30
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: count_by_eventtype_tracker
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: event_id_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: event_name_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: page_page_type_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: page_page_name_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: location_latitude_not_null
            check-result: 'true'
            check-impact: minor
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: location_longitude_not_null
            check-result: 'true'
            check-impact: minor
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_id_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_id_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_type_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_adtype_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_category_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_content_id_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_currency_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_location_address_locality_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_location_address_region_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_location_postal_code_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_price_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_publisher_type_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_publisher_id_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_url_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: provider_id_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: provider_product_type_not_null
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: device_environment_id_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: device_device_type_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: tracker_type_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: published_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: provider_type_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: actor_id_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: actor_sptid_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: event_type_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_publisher_id_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: tracker_name_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: tracker_version_not_null
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: device_environment_id_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: actor_id_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: actor_sptid_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: published_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: deploy_stage_valid_value
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: location_latitude_valid_format
            check-result: 'true'
            check-impact: minor
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: location_longitude_valid_format
            check-result: 'false'
            check-impact: minor
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_id_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_publisher_id_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_price_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_category_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_location_address_region_valid_format
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_location_address_locality_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: object_location_postal_code_valid_format
            check-result: 'true'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: device_is_bot
            check-result: 'false'
            check-impact: critical
          delta: 1
      - quality.check:
          tags:
            tracker-type: android
            event-type: view
            check-suite: p10n.view-event
            check-name: sdk_version_is_supported
            check-result: 'true'
            check-impact: critical
          delta: 1

    expression: |
      import "checks/p10n/classified-ad-interactions.jslt" as c

      let some_time = format-time(now() - 3*60, "yyyy-MM-dd'T'HH:mm:ssX")

      // event got from https://github.mpi-internal.com/spt-dataanalytics/event-formats/blob/d3604512b5b117eb8095cd0708dd12b0e976508d/examples/events/page-view-classifiedad-marketplace.json
      let event =
      {
        "@id": "2a3e79df-62e0-49c9-af9f-f3be11fa356f",
        "@type": "View",
        "actor": {
          "@id": "sdrn:schibsted:user:27a0c20b-71dd-4fca-a8b6-a3810c7a164d",
          "spt:userId": "sdrn:schibsted:user:27a0c20b-71dd-4fca-a8b6-a3810c7a164d",
          "spt:remoteAddress": "127.0.0.1"
        },
        "device": {
          "acceptLanguage": "en-US",
          "deviceType": "desktop",
          "environmentId": "sdrn:schibsted:environment:a2029f7e-1a7f-46db-a683-b4f62e0ec9ad",
          "jweIds": "eyJhbGciOiJBMTI4S1ciLCJlbmMiOiJBMTI4R0NNIn0.1rCvgZU-wfbZ2SaPjwtzbgbgrA4eMa7t.UA4RBtNGMww3s05l.LxNPW9VKQbmHMy1L1SrHtd3xZtRLsdIB7KYZXiEcXTFtNbXKMbm9aQhcajymFDMOWB_3DsYS2e_lp55-3ptpxvj9Ttg2Alw9D0whQlLgo5YTjSijWsk1jpnrcWA2HwyvHakfpI4jne9nBSOLS9vt_GlHV2IFqS7PW0ITjpSoXZBRJejzJtj7IZnnICuWJnU0RBplXJ6dZL199uB0AcVC7v46jO8IItEoA2eSrd3JRZFSvRb6S_244Sg.gNJrRPleXE011yjCOANVgg",
          "screenSize": "1680x1050",
          "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.104 Safari/537.36",
          "viewportSize": "1313x502",
          "isBot": false
        },
        "location": {
          "@type": "GeoCoordinates",
          "latitude": "40.75",
          "longitude": "11.ef",
          "timestamp": 1456919653000
        },
        "object": {
          "@id": "sdrn:blocket:classified:66225237",
          "@type": "ClassifiedAd",
          "adType": "sell",
          "category": "2000 > 2050",
          "location": {
            "@type": "PostalAddress",
            "addressCountry": "Sweden",
            "addressLocality": "Uppsala City",
            "addressRegion": {
                "name": "Uppsala County"
            },
            "postalCode": "75238",
            "streetAddress": "Thunbergsvägen 3P"
          },
          "price": 200,
          "name": "Skänk + matsalsbord och 6 klädda stolar 40tal | Örebro",
          "publisher": {
            "@id": "sdrn:blocket:user:31372",
            "@type": "Account",
            "name": "Uppsala University"
          },
          "publisherType": "pro",
          "url": "https://www.blocket.se/orebro/Skank___matsalsbord_och_6_kladda_stolar_40tal_66225237.htm?ca=8&w=1"
        },
        "pageViewId": "2a3e79df-62e0-49c9-af9f-f3be11fa356f",
        "provider": {
          "@id": "sdrn:schibsted:client:blocket",
          "@type": "Organization"
        },
        "creationDate": $some_time,
        "published": $some_time,
        "schema": "http://schema.adevinta.com/events/tracker-event.json/237.json#",
        "tracker": {
          "@type": "Tracker",
          "name": "publish-stream",
          "type": "Android",
          "version": "8.0.1"
        }
      }
      c($event)

