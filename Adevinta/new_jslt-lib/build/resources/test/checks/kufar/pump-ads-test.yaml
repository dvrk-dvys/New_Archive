tests:

  - name: pump-ads.jslt compiles
    type: compile
    expression: |
      import "checks/kufar/pump-ads.jslt" as f
      f(.)

  - name: pump-ads.jslt checks valid event with ads data produced by Pump
    expression: |
      import "checks/kufar/pump-ads.jslt" as pump-ads-checks

      let event = {
        "query_time": "2020-08-28T14:47:09+03:00",
        "query_lag_sec": 1.534309,
        "ad_id": 106730217,
        "event_id": 1241185814,
        "state_id": 1241185814,
        "state": "accepted",
        "transition": "bump",
        "action_id": 7,
        "ip": null,
        "ad_changes": null,
        "event_ts_utc": 1598615228088.28,
        "naive_ad_id": 106730217,
        "naive_list_id": 93575559,
        "naive_account_id": 123,
        "naive_published_at": "2020-08-25T14:45:36+03:00",
        "naive_orig_list_time": "2020-08-25T14:45:36+03:00",
        "naive_list_time": "2020-08-28T14:47:08+03:00",
        "naive_modified_at": "2020-08-28T14:47:08+03:00",
        "naive_status": "active",
        "naive_name": "Joe",
        "naive_phone": "375296665102",
        "naive_region": 7,
        "naive_category": 5060,
        "naive_user_id": 99999,
        "naive_phone_hidden": true,
        "naive_body": "text",
        "naive_price": 0,
        "naive_company_ad": false,
        "naive_subject": "text",
        "naive_user_type": "private",
        "naive_ad_images": [
          9958850494,
          9963410150,
          9974213297,
          9908306573,
          9933876530
        ],
        "naive_ad_params": "{ \"highlight_end\" : \"1598960828\", \"video_tv_brand\" : \"47\", \"clear_phone_1\" : \"375291234567\", \"currency\" : \"BYR\", \"video_tv_type\" : \"3\", \"area\" : \"24\", \"tv_type\" : \"1\", \"remuneration_type\" : \"1\", \"condition\" : \"1\", \"video_tv_diagonal\" : \"35\", \"delivery_enabled\" : \"1\" }",
        "queue": "medium",
        "queued_at_minsk_time": 1598626024319.08,
        "locked_by": null,
        "locked_until_minsk_time": null
      }

      pump-ads-checks($event)

    expected:
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: state_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: state_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: transition_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: action_id_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: event_ts_utc_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_ad_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_account_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_status_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_name_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1                                            
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_phone_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_category_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_phone_hidden_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_body_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_subject_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_user_type_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_ad_params_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_id_is_positive_integer
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: state_id_is_positive_integer
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: transition_is_one_of
            check-result: 'true'
            check-impact: minor
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: action_id_is_positive_integer
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ip_is_correct
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_changes_is_nullable_struct
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: event_ts_utc_is_number
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: event_ts_utc_is_unix_ts_in_milliseconds
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_ad_id_is_positive_integer
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_list_id_is_positive_nullable_integer
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_account_id_is_positive_integer
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_orig_list_time_is_nullable_iso8061_ts
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_list_time_is_nullable_iso8061_ts
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_modified_at_is_nullable_iso8061_ts
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_status_is_one_of
            check-result: 'true'
            check-impact: minor
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_name_is_string
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_phone_is_string
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_region_is_in_valid_range
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_category_is_positive_integer
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_body_is_string
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_subject_is_string
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_price_is_zero_or_positive_nullable_integer
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: area_is_in_valid_range
            check-result: 'true'
            check-impact: critical
            action-state: accepted
          delta: 1       
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_id_and_naive_ad_id_match
            check-result: 'true'
            check-impact: blocker
            action-state: accepted
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: query_lag_is_not_greater_than_expected
            check-result: 'true'
            check-impact: minor
            action-state: accepted
          delta: 1

  - name: pump-ads.jslt checks invalid event with ads data produced by Pump
    expression: |
      import "checks/kufar/pump-ads.jslt" as pump-ads-checks

      let invalid_event = {
        "query_time": "2020-08-28 14:47:09",
        "query_lag_sec": 10000,
        "ad_id": 106730217,
        "event_id": 1241185814,
        "state_id": "1241185814",
        "state": "some_other_state",
        "transition": null,
        "action_id": "None",
        "ip": "111",
        "ad_changes": "text 1 -> text 2",
        "event_ts_utc": 1598813744,
        "naive_ad_id": 123,
        "naive_list_id": 93575559,
        "naive_account_id": 123,
        "naive_published_at": "2020-08-28 14:47:09",
        "naive_orig_list_time": "2020-08-28 14:47:09",
        "naive_list_time": "2020-08-28 14:47:09",
        "naive_modified_at": "2020-08-28 14:47:09",
        "naive_status": "unknown",
        "naive_name": "Joe",
        "naive_phone": 375291234567,
        "naive_region": -1,
        "naive_category": 5060,
        "naive_user_id": 99999,
        "naive_phone_hidden": true,
        "naive_body": "text",
        "naive_price": "20.1 BYR",
        "naive_company_ad": false,
        "naive_subject": "text",
        "naive_user_type": "private",
        "naive_ad_images": [
          9958850494,
          9963410150,
          9974213297,
          9908306573,
          9933876530
        ],
        "naive_ad_params": "{ \"highlight_end\" : \"1598960828\", \"video_tv_brand\" : \"47\", \"clear_phone_1\" : \"375291234567\", \"currency\" : \"BYR\", \"video_tv_type\" : \"3\", \"area\" : \"900000\", \"tv_type\" : \"1\", \"remuneration_type\" : \"1\", \"condition\" : \"1\", \"video_tv_diagonal\" : \"35\", \"delivery_enabled\" : \"1\" }",
        "queue": "medium",
        "queued_at_minsk_time": 1598626024319.08,
        "locked_by": null,
        "locked_until_minsk_time": null
      }

      pump-ads-checks($invalid_event)

    expected:
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: state_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: state_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: transition_is_not_null
            check-result: 'false'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: action_id_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: event_ts_utc_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_ad_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_account_id_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_status_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_name_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1                                            
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_phone_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_category_is_not_null
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_phone_hidden_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_body_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_subject_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_user_type_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_ad_params_is_not_null
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_id_is_positive_integer
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: state_id_is_positive_integer
            check-result: 'false'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: transition_is_one_of
            check-result: 'false'
            check-impact: minor
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: action_id_is_positive_integer
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ip_is_correct
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_changes_is_nullable_struct
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: event_ts_utc_is_number
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: event_ts_utc_is_unix_ts_in_milliseconds
            check-result: 'false'
            check-impact: blocker
            action-state: unknown
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_ad_id_is_positive_integer
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_list_id_is_positive_nullable_integer
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_account_id_is_positive_integer
            check-result: 'true'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_orig_list_time_is_nullable_iso8061_ts
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_list_time_is_nullable_iso8061_ts
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_modified_at_is_nullable_iso8061_ts
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_status_is_one_of
            check-result: 'false'
            check-impact: minor
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_name_is_string
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_phone_is_string
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_region_is_in_valid_range
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1         
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_category_is_positive_integer
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_body_is_string
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_subject_is_string
            check-result: 'true'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: naive_price_is_zero_or_positive_nullable_integer
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: area_is_in_valid_range
            check-result: 'false'
            check-impact: critical
            action-state: unknown
          delta: 1       
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: ad_id_and_naive_ad_id_match
            check-result: 'false'
            check-impact: blocker
            action-state: unknown
          delta: 1
      - quality.check:
          tags:
            check-suite: kufar.pump_ads
            check-name: query_lag_is_not_greater_than_expected
            check-result: 'false'
            check-impact: minor
            action-state: unknown
          delta: 1      