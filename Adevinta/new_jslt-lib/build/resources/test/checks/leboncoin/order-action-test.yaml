tests:

  - name: order-action.jslt compiles
    type: compile
    expression: |
      import "checks/leboncoin/order-action.jslt" as f
      f(.)

  - name: order-action.jslt checks valid orderv2 event
    expected:
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: event_count
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: user_id_is_not_empty
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: user_id_is_not_null
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: user_ip_is_valid
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: user_email_is_valid
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: event_datetime_is_not_null
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: event_datetime_is_valid
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: not_ratio_x_value_equals_total
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: not_all_ratio_x_value_equals_total_in_items
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: order_type_is_one_of
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: all_item_type_is_not_empty
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: all_payment_type_are_one_of
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: all_payment_status_are_one_of
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: all_updated_time_are_valid_in_payments
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
      - quality.check:
          tags:
            check-suite: leboncoin.order_action
            check-name: sum_of_prices_equals_total
            check-result: 'true'
            check-impact: critical
            order-type: ad_action
          delta: 1
    expression: |
      import "checks/leboncoin/order-action.jslt" as payment-checks

      let event =
      {"order_id": "5de13073-45b1-4097-8d3d-708229f51fdf", "merchant_id": null, "event_datetime": "2020-05-22T13:38:51Z", "user_id": "23ebc915-dc65-41db-b726-89cf1421e36c", "user_ip": "10.109.153.220", "user_name": "", "user_mail": "bertrandleg@yahoo.fr", "user_siren": null, "order_type": "ad_action", "user_address": "", "user_type": "private", "total": 2010, "total_no_tax": 1675, "tax_rate": 0.0, "autocapture": false, "bypass_3ds": false, "items": [{"description": "Option A la une pendant 7 jours", "item_type": {"service": "options-submit"}, "price": 2010, "price_no_tax": 1675, "tax_rate": 20.0, "metadata": "{\"action_id\":10,\"ad_id\":1773767065,\"list_id\":1773767065,\"price_id\":\"af3244bb-c9aa-4419-ba36-afce97ef4c42\",\"product_type\":\"gallery\",\"transaction_type\":\"ad_action\"}", "target_user": null, "target_entity": null}], "payments": [{"type": "CARD", "paid": 2010, "revenue": 2010, "status": "AUTHORIZATION_PENDING", "reference": null, "metadata": "{\"merchant_reference\":\"975900211\",\"provider\":\"ADYEN\"}", "updated": "2020-05-22T13:38:51Z"}], "status": "authorization_pending"}
      payment-checks($event)